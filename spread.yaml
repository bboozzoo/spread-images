project: spread-images

environment:
    PROJECT_PATH: /root/spread
    TESTSLIB: $PROJECT_PATH/lib
    TESTSFILES: $PROJECT_PATH/files

backends:

    google:
        key: "$(HOST: echo $SPREAD_GOOGLE_KEY)"
        location: computeengine/us-east1-b
        systems:
            - ubuntu-14.04-64:
                workers: 1
            - ubuntu-16.04-32:
                workers: 1
            - ubuntu-16.04-64:
                workers: 1
            - ubuntu-18.04-64:
                image: ubuntu-os-cloud-devel/daily-ubuntu-1804-bionic-v20180315
                workers: 1

            - ubuntu-core-16-64:
                image: ubuntu-16.04-64
                workers: 1

            - debian-9-64:
                image: debian-9-stretch
                workers: 1
            - debian-sid-64:
                image: debian-sid-64
                workers: 1

            - fedora-27-64:
                image: fedora-27-64
                workers: 1
            - fedora-27-64-selinux-enforcing:
                image: fedora-27-64-selinux-enforcing
                workers: 1
            - fedora-27-64-selinux-permissive:
                image: fedora-27-64-selinux-permissive
                workers: 1

            - opensuse-42.2-64:
                image: opensuse-leap-42-2
                workers: 1
                manual: true
            - opensuse-42.3-64:
                image: opensuse-cloud/opensuse-leap-42-3-v20180116
                workers: 1

            - arch-linux-64:
                workers: 1

            - amazon-linux-2-64:
                workers: 1
                preserve: true

    linode:
        key: "$(HOST: echo $SPREAD_LINODE_KEY)"
        systems:
            - ubuntu-16.04-64:
                kernel: GRUB 2
            - ubuntu-16.04-32:
                kernel: GRUB 2
            - ubuntu-16.10-64:
                kernel: GRUB 2
            - ubuntu-17.04-64:
                kernel: GRUB 2
            - ubuntu-17.10-64:
                kernel: GRUB 2
            - debian-unstable-64:
                kernel: GRUB 2

path: /root/spread

suites:
    tasks/google/:
        summary: Create and update images for google backend
        environment:
            GCE_PROJECT: computeengine
            ZONE: us-east1-b
            BUCKET_NAME: spread-images
        prepare: |
            . "$TESTSLIB/pkgdb.sh"

            if ! [ -f "$PROJECT_PATH/sa.json" ]; then
                echo "Service account file not found in root path"
                exit 1
            fi
            distro_update_package_db
            install_pkg_dependencies
            gcloud auth activate-service-account --key-file="$PROJECT_PATH/sa.json"

    tasks/linode/:
        summary: Update images for Linode backend
